<!DOCTYPE html>
<html>
<head>
    <title>Benchmark Results</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.12/vue.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chartjs-plugin-crosshair@1.1.6'></script>
    <style type="text/css">
#data-table {
    overflow-x: scroll;
}
th {
    font-size: larger;
    text-align: center;
}
td.numeric {
    text-align: right;
    font-family: monospace;
}
td.diff {
    font-size: 9pt; color: #c0c0c0;
}
td.clickable {
    cursor: pointer;
}
td.clickable:hover {
    color: blue;
}
td.WARM_UP {
    background-color: #fff8ee;
}
tr:hover td.WARM_UP {
    background-color: #ffe6d4;
}
td.MEASURE {
    background-color: #eeffee;
}
tr:hover td.MEASURE {
    background-color: #d8ffd8;
}
div.controls > div.col-form-label {
    text-align: right;
}
footer {
    margin-top: 2em;
    padding: 1em;
    color: #aaa;
    background-color: #eee;
    font-size: smaller;
    text-align: right;
    border-top: 1px solid #ddd;
}
    </style>
    <script>
const Phase = {
    WARM_UP: "WARM_UP",
    MEASURE: "MEASURE"
};

let benchmarkResult =
@@BENCHMARK_RESULT_JSON@@
;
</script>
</head>
<body>
<div id="app">
<nav class="navbar navbar-dark bg-dark">
<span class="navbar-brand mb-0 h1">Benchmark results</span>
</nav>
<div class='container-fluid'>
<div class='row mt-3'>
    <div class='col ml-auto mr-auto'>
        <canvas id='samples' style="width: 100%; height: 400px;"></canvas>
    </div>
</div>
<div class="form-group form-row controls mt-3">
    <div class="form-group col-md-2">
        <div class="btn-group btn-group-toggle" data-toggle="buttons">
            <label class="btn btn-secondary" :class="{ active: options.order === 'historical' }">
                <input type="radio" name="order" v-model="options.order" value="historical"> Historical
            </label>
            <label class="btn btn-secondary" :class="{ active: options.order === 'sorted' }">
                <input type="radio" name="order" v-model="options.order" value="sorted"> Sorted
            </label>
        </div>
    </div>
</div>
<div class="row mt-3">
    <div class='col ml-auto mr-auto'>
        <div id="data-table">
            <div class='row'>
                <div class='col'>
                    <table class='table table-sm table-hover'>
                        <thead>
                            <tr>
                                <th>Scenario</th>
                                <th>Version</th>
                                <th>Tasks</th>
                                <th></th>
                                <th>Sample</th>
                                <th>Mean</th>
                                <th>Min</th>
                                <th>P25</th>
                                <th>Median</th>
                                <th>P75</th>
                                <th>Max</th>
                                <th>Std.dev</th>
                                <th>Confidence</th>
                                <th :colspan="Math.max(...benchmarkResult.scenarios.map(scenario => scenario.iterations.length))">Builds</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="scenario in benchmarkResult.scenarios">
                                <template v-for="(sample, index) in scenario.samples">
                                    <tr>
                                        <td v-if="index === 0" :rowspan="scenario.samples.length">{{ scenario.definition.title }}</td>
                                        <td v-if="index === 0" :rowspan="scenario.samples.length">{{ scenario.definition.buildTool }}</td>
                                        <td v-if="index === 0" :rowspan="scenario.samples.length">{{ scenario.definition.tasks }}</td>
                                        <td class="clickable" @click="select(scenario, sample)" :style="sample.style"><i class="fa fa-check-square"></i></td>
                                        <td class="clickable" @click="select(scenario, sample)">{{ sample.name }}</td>
                                        <td class="numeric">{{ calc('mean', sample, scenario) | numeric }}</td>
                                        <td class="numeric">{{ calc('p25', sample, scenario) | numeric }}</td>
                                        <td class="numeric">{{ calc('min', sample, scenario) | numeric }}</td>
                                        <td class="numeric">{{ calc('median', sample, scenario) | numeric }}</td>
                                        <td class="numeric">{{ calc('p75', sample, scenario) | numeric }}</td>
                                        <td class="numeric">{{ calc('max', sample, scenario) | numeric }}</td>
                                        <td class="numeric">{{ calc('stddev', sample, scenario) | numeric }}</td>
                                        <td class="numeric">{{ sample.confidence | percent }}</td>
                                        <template v-for="iteration in scenario.iterations">
                                            <td class="numeric" :class="iteration.phase" :title="iteration.phase + ' #' + iteration.iteration">{{ iteration.values[sample.name] | numeric }}</td>
                                        </template>
                                    </tr>
                                </template>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<footer>
    <span>Gradle Profiler version {{ benchmarkResult.environment.profilerVersion }}</span>
</footer>
</div>
<script>
Array.prototype.unique = function() { return [...new Set(this)]; };

function toggleSample(sample, enabled) {
    if (enabled) {
        sample.style = {
            visibility: "visible"
        };
    } else {
        sample.style = {
            visibility: "hidden"
        };
    }
}

// Initialize sample config
benchmarkResult.scenarios.forEach(scenario => scenario.samples.forEach((sample, index) => toggleSample(sample, false)));

function iterations(scenario, phase) {
    return scenario.iterations.filter(iteration => iteration.phase === phase);
}
function sort(array) {
    return array.slice().sort((a, b) => a - b);
}

function quantile(data, q) {
    const sorted = sort(data);
    const pos = (sorted.length - 1) * q;
    const base = Math.floor(pos);
    const rest = pos - base;
    if (sorted[base + 1] !== undefined) {
        return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
    } else {
        return sorted[base];
    }
};

function mean(data) {
    return data.reduce((sum, val) => sum + val) / data.length;
}

const OPERATIONS = {
    "mean": (data) => mean(data),
    "min": (data) => Math.min(...data),
    "max": (data) => Math.max(...data),
    "p25": (data) => quantile(data, .25),
    "median": (data) => quantile(data, .50),
    "p75": (data) => quantile(data, .75),
    "stddev": (data) => {
        let dataMean = mean(data);
        return Math.sqrt(mean(data.map(x => Math.pow(x - dataMean, 2))));
    }
};

function convertScenarioToChart(scenario, sample, sorted, color) {
    var data = iterations(scenario, Phase.MEASURE)
            .map(iteration => iteration.values[sample.name]);
    if (sorted) {
        data = data.sort((a, b) => b - a);
    }
    return {
        label: `${scenario.definition.title} (${sample.name}) ${scenario.definition.buildTool}`,
        showLine: true,
        steppedLine: "middle",
        pointRadius: 0,
        pointHitRadius: 10,
        hoverRadius: 6,
        fill: false,
        borderWidth: 3,
        pointBackgroundColor: color,
        borderColor: color,
        data: data
    };
}

const COLORS = ["#527AB3", "#56ac76", "#f44336", "#d49c3e", "#211f2d"];
class PaletteGenerator {
    constructor() {
        this.colors = COLORS.slice();
    }
    nextColor() {
        if (this.colors.length) {
            return this.colors.shift();
        } else {
            return "#8B899A";
        }
    }
};

function updateData() {
    let sorted = this.options.order === "sorted";
    let selected = this.options.selected;
    let palette = new PaletteGenerator();
    chart.data.datasets = selected.map(item => convertScenarioToChart(item.scenario, item.sample, sorted, palette.nextColor()));
    chart.update();
}

class SelectedItem {
    constructor(scenario, sample) {
        this.scenario = scenario;
        this.sample = sample;
    }

    equals(other) {
        return other !== null
            && this.scenario === other.scenario
            && this.sample === other.sample;
    }
}

var app = new Vue({
    el: '#app',
    data: {
        options: {
            order: "historical",
            selected: []
        },
        benchmarkResult: benchmarkResult
    },
    watch: {
        "options.order": updateData,
        "options.selected": updateData
    },
    methods: {
        calc: (operation, sample, scenario) => {
            let data = iterations(scenario, Phase.MEASURE).map(iteration => iteration.values[sample.name]);
            return OPERATIONS[operation](data);
        },
        select: function(scenario, sample) {
            let selected = this.options.selected;
            let item = new SelectedItem(scenario, sample);
            let index = selected.findIndex(it => item.equals(it));
            if (index === -1) {
                selected.push(item);
            } else {
                selected.splice(index, 1);
            }
            toggleSample(sample, index === -1);
        }
    },
    filters: {
        "numeric": (value) => value.toFixed(2),
        "percent": (value) => (value * 100).toFixed(2) + "%"
    },
    created: function(x, y, z) {
        this.benchmarkResult.scenarios.forEach(scenario => this.select(scenario, scenario.samples[0]));
    }
});

let ctx = document.getElementById('samples').getContext('2d');
let maxMeasuredIterations = Math.max(...(benchmarkResult.scenarios.map(scenario => iterations(scenario, Phase.MEASURE).length)));
let chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: Array.from(Array(maxMeasuredIterations), (_, i) => (i + 1).toString()),
        datasets: []
    },
    options: {
        plugins: {
            crosshair: {
                zoom: {
                    enabled: false
                },
                snap: {
                    enabled: false
                }
            }
        },
        responsive: false,
        animation: {
            duration: 0
        },
        legend: {
            position: "bottom",
            align: "start",
            fullWidth: false
        },
        tooltips: {
            mode: "index",
            position: "nearest",
            itemSort: (a, b) => b.yLabel - a.yLabel,
            callbacks: {
                title: (tooltips, data) => `Build #${tooltips[0].label}`,
                label: (tooltip, data) => tooltip.yLabel.toFixed(2)
            }
        },
        hover: {
            intersect: false
        },
        scales: {
            yAxes: [{
                ticks: {
                    min: 0
                }
            }]
        }
    }
});
</script>

</body>
</html>
